{% extends 'base.html' %}
{% load static %}

{% block title %}المحادثة - دلال السعودية{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-md-8 mx-auto">
            <!-- Header -->
            <div class="card mb-3">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-0">
                                <i class="fas fa-comments"></i>
                                {% if conversation.product %}
                                    محادثة حول: {{ conversation.product.title|truncatechars:40 }}
                                {% else %}
                                    محادثة عامة
                                {% endif %}
                            </h5>
                            <small>
                                المشاركون: 
                                {% for participant in conversation.participants.all %}
                                    {{ participant.username }}{% if not forloop.last %}, {% endif %}
                                {% endfor %}
                            </small>
                        </div>
                        <a href="{% url 'messaging:inbox' %}" class="btn btn-light btn-sm">
                            <i class="fas fa-arrow-right"></i> العودة
                        </a>
                    </div>
                </div>
                
                {% if conversation.product %}
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-2">
                            {% if conversation.product.images.first %}
                                <img src="{{ conversation.product.images.first.image.url }}" 
                                     alt="{{ conversation.product.title }}" 
                                     class="img-fluid rounded">
                            {% endif %}
                        </div>
                        <div class="col-md-8">
                            <h6>{{ conversation.product.title }}</h6>
                            <p class="text-muted mb-1">{{ conversation.product.description|truncatechars:100 }}</p>
                            <span class="h5 text-success">{{ conversation.product.price }} ريال</span>
                        </div>
                        <div class="col-md-2">
                            <a href="{% url 'products:detail' conversation.product.id %}" 
                               class="btn btn-outline-primary btn-sm">
                                عرض المنتج
                            </a>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
            
            <!-- Messages -->
            <div class="card">
                <div class="card-body">
                    <div class="chat-container" id="chatContainer">
                        {% for message in messages %}
                        <div class="message {% if message.sender == user %}sent{% else %}received{% endif %}">
                            <div class="message-content">
                                <p class="mb-1">{{ message.content }}</p>
                                <small class="text-muted">
                                    {{ message.sender.username }} - {{ message.timestamp|date:"Y-m-d H:i" }}
                                </small>
                            </div>
                        </div>
                        {% empty %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-comments fa-3x mb-3"></i>
                            <p>لا توجد رسائل بعد. ابدأ المحادثة!</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                
                <!-- Send Message Form -->
                <div class="card-footer">
                    <form method="post" id="messageForm">
                        {% csrf_token %}
                        <div class="input-group">
                            <input type="text" name="content" class="form-control" 
                                   placeholder="اكتب رسالتك هنا..." required>
                            <button class="btn btn-primary" type="submit">
                                <i class="fas fa-paper-plane"></i> إرسال
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.chat-container {
    max-height: 400px;
    overflow-y: auto;
    padding: 1rem;
    background-color: #f8f9fa;
    border-radius: 10px;
}

.message {
    margin-bottom: 1rem;
    display: flex;
}

.message.sent {
    justify-content: flex-end;
}

.message.received {
    justify-content: flex-start;
}

.message-content {
    max-width: 70%;
    padding: 0.75rem 1rem;
    border-radius: 15px;
    word-wrap: break-word;
}

.message.sent .message-content {
    background-color: var(--primary-color);
    color: white;
    border-bottom-left-radius: 5px;
}

.message.received .message-content {
    background-color: white;
    border: 1px solid #e9ecef;
    border-bottom-right-radius: 5px;
}

.message.sent .message-content small {
    color: rgba(255,255,255,0.8);
}

#messageForm input[name="content"] {
    border-radius: 25px 0 0 25px;
}

#messageForm button {
    border-radius: 0 25px 25px 0;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Scroll to bottom of chat
    const chatContainer = document.getElementById('chatContainer');
    chatContainer.scrollTop = chatContainer.scrollHeight;
    
    // Auto-scroll on new messages
    const messageForm = document.getElementById('messageForm');
    messageForm.addEventListener('submit', function() {
        setTimeout(() => {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }, 100);
    });
});
</script>
{% endblock %}

